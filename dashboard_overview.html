<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Logistics â€” Overview Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f14; --card:#111827; --ink:#e5e7eb; --ink-dim:#94a3b8;
      --border:#232a36; --brand:#60a5fa; --radius:16px;
      --good:#34d399; --warn:#fbbf24; --bad:#f87171;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1280px;margin:0 auto;padding:16px}
    .header{display:flex;align-items:center;justify-content:space-between;padding:8px 0}
    .brand{font-weight:800;font-size:18px;letter-spacing:.2px}
    .badge{font-size:12px;color:#06220b;background:#c7f9cc;border:0;padding:6px 10px;border-radius:999px}
    .err{background:#ffd6d6;color:#3f0000}
    .grid{display:grid;gap:12px}
    .kpis{grid-template-columns:repeat(auto-fit,minmax(170px,1fr));margin:10px 0}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px}
    .kpi h4{margin:0 0 4px;color:var(--ink-dim);font-weight:600;font-size:12px}
    .kpi .val{font-size:22px;font-weight:800}
    .layout{grid-template-columns:1.2fr 1fr}
    @media (max-width:1000px){ .layout{grid-template-columns:1fr} }
    canvas{width:100%;height:280px}
    #map{height:320px;border-radius:16px;overflow:hidden}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){ .row{grid-template-columns:1fr} }
    .hbar{height:280px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--border);padding:8px;text-align:left}
    th{color:var(--ink-dim);font-weight:600}
    .small{font-size:12px;color:var(--ink-dim)}
  </style>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <div class="brand">ðŸšš Logistics â€” Overview</div>
      <div id="status" class="badge">Connectingâ€¦</div>
    </header>

    <section class="grid kpis">
      <div class="card kpi"><h4>Revenue (latest month)</h4><div class="val" id="kpiRevenue">â€”</div></div>
      <div class="card kpi"><h4>Income (YTD)</h4><div class="val" id="kpiIncome">â€”</div></div>
      <div class="card kpi"><h4>Expenses (YTD)</h4><div class="val" id="kpiExpenses">â€”</div></div>
      <div class="card kpi"><h4>Savings / Profit (YTD)</h4><div class="val" id="kpiProfit">â€”</div></div>
      <div class="card kpi"><h4>Deliveries (latest month)</h4><div class="val" id="kpiDeliveries">â€”</div></div>
    </section>

    <section class="grid layout">
      <div class="grid" style="gap:12px">
        <div class="card">
          <h3 style="margin:0 0 6px">Income vs Expenses (Timeline)</h3>
          <canvas id="lineIE"></canvas>
        </div>
        <div class="card">
          <h3 style="margin:0 0 6px">Sales Target % per Rep (YTD)</h3>
          <canvas id="barTargets" class="hbar"></canvas>
          <div class="small">100% means target met for the year to date.</div>
        </div>
      </div>
      <div class="grid" style="gap:12px">
        <div class="card">
          <h3 style="margin:0 0 6px">Trade Map â€” Imports & Exports</h3>
          <div id="map"></div>
        </div>
        <div class="row">
          <div class="card"><h3 style="margin:0 0 6px">Successful Transactions</h3><canvas id="donutSuccess"></canvas></div>
          <div class="card"><h3 style="margin:0 0 6px">Returning Customer Rate</h3><canvas id="donutReturning"></canvas></div>
        </div>
        <div class="card">
          <h3 style="margin:0 0 6px">Last 5 Orders</h3>
          <div style="overflow:auto">
            <table id="tblOrders">
              <thead><tr><th>Order ID</th><th>Product</th><th>Quantity</th><th>Amount Paid (ZAR)</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
  let SUPABASE_URL = window.SUPABASE_URL;
  let SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY;
  if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
    try{ const mod = await import('./js/config.js'); SUPABASE_URL = mod.SUPABASE_URL; SUPABASE_ANON_KEY = mod.SUPABASE_ANON_KEY; }catch(e){}
  }
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const status = document.getElementById('status');
  const fmtZAR = (n) => n == null ? 'â€”' : new Intl.NumberFormat('en-ZA',{style:'currency',currency:'ZAR',maximumFractionDigits:0}).format(Number(n));

  try{ const { error } = await supabase.from('v_profit_monthly').select('*').limit(1); if(error) throw error; status.textContent='Connected'; }catch(e){ status.textContent='Error'; status.className='badge err'; console.error(e); }

  const { data: pm } = await supabase.from('v_profit_monthly').select('*').order('month');
  if(pm && pm.length){
    const labels = pm.map(r => new Date(r.month).toISOString().slice(0,7));
    const inc = pm.map(r => Number(r.income_zar||0));
    const exp = pm.map(r => Number(r.expense_zar||0));
    const latest = pm[pm.length-1];
    document.getElementById('kpiRevenue').textContent = fmtZAR(Number(latest.income_zar||0));
    const yr=new Date().getFullYear(); let yInc=0,yExp=0;
    pm.filter(r=>new Date(r.month).getFullYear()===yr).forEach(r=>{ yInc+=Number(r.income_zar||0); yExp+=Number(r.expense_zar||0); });
    document.getElementById('kpiIncome').textContent = fmtZAR(yInc);
    document.getElementById('kpiExpenses').textContent = fmtZAR(yExp);
    document.getElementById('kpiProfit').textContent = fmtZAR(yInc-yExp);
    new Chart(document.getElementById('lineIE').getContext('2d'), { type:'line', data:{ labels, datasets:[ {label:'Income', data:inc}, {label:'Expenses', data:exp} ] }, options:{ responsive:true, scales:{ y:{ beginAtZero:true } } } });
    const start = new Date(latest.month);
    const next = new Date(start.getFullYear(), start.getMonth()+1, 1).toISOString();
    const delivered = await supabase.from('shipments').select('id', { count:'exact', head:true }).gte('delivered_at', start.toISOString()).lt('delivered_at', next).eq('status','delivered');
    document.getElementById('kpiDeliveries').textContent = delivered.count ?? 'â€”';
  }

  const { data: ytdRows } = await supabase.from('v_sales_vs_target').select('*');
  if(ytdRows){
    const yr = new Date().getFullYear();
    const byRep = {};
    ytdRows.filter(r=>new Date(r.month).getFullYear()===yr).forEach(r=>{
      const k=r.full_name; byRep[k]=(byRep[k]||{sales:0,target:0}); byRep[k].sales+=Number(r.sales_zar||0); byRep[k].target+=Number(r.target_zar||0);
    });
    const labels=Object.keys(byRep);
    const pct=labels.map(k=>{ const t=byRep[k]; return t.target>0 ? Math.min(150, Math.round(100*t.sales/t.target)) : 0; });
    new Chart(document.getElementById('barTargets').getContext('2d'), { type:'bar', data:{ labels, datasets:[{label:'% to YTD Target', data:pct}] }, options:{ indexAxis:'y', responsive:true, scales:{ x:{ beginAtZero:true, max:150 } } } });
  }

  const allInv = await supabase.from('invoices').select('id,status');
  if(!allInv.error){
    const total=allInv.data.length, paid=allInv.data.filter(i=>i.status==='paid').length;
    new Chart(document.getElementById('donutSuccess').getContext('2d'), { type:'doughnut', data:{ labels:['Paid','Other'], datasets:[{ data:[paid, Math.max(0,total-paid)] }] } });
  }
  const invClients = await supabase.from('invoices').select('client_id');
  if(!invClients.error){
    const counts={}; (invClients.data||[]).forEach(r=>{ counts[r.client_id]=(counts[r.client_id]||0)+1; });
    const ones=Object.values(counts).filter(c=>c===1).length;
    const twoplus=Object.values(counts).filter(c=>c>=2).length;
    new Chart(document.getElementById('donutReturning').getContext('2d'), { type:'doughnut', data:{ labels:['Returning','First-time'], datasets:[{ data:[twoplus, ones] }] } });
  }

  const GEO={'CN':[35.0,103.0],'DE':[51.0,10.0],'IN':[21.0,78.0],'BR':[-10.0,-55.0],'NL':[52.1,5.3],'ZA':[-28.5,24.7]};
  const map=L.map('map',{zoomControl:false,dragging:false,scrollWheelZoom:false,doubleClickZoom:false,boxZoom:false,keyboard:false}).setView([15,10],2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:2,attribution:'Â© OpenStreetMap'}).addTo(map);
  function arc(a,b,color){ L.polyline([a,b],{color,weight:2,opacity:0.7}).addTo(map); }
  function bubble(latlon,val,color,title){ const r=Math.max(5,Math.sqrt(val)/200); L.circleMarker(latlon,{radius:r,color,weight:1,fillOpacity:0.5}).addTo(map).bindTooltip(title); }
  const hub=GEO['ZA'];
  const imp=await supabase.from('v_imports_by_country').select('*');
  (imp.data||[]).forEach(r=>{ const g=GEO[r.country_iso2]; if(!g) return; bubble(g, Number(r.import_value_zar||0), '#60a5fa', `${r.country_iso2}: ZAR ${Math.round(r.import_value_zar).toLocaleString()}`); arc(g, hub, '#60a5fa'); });
  const exp=await supabase.from('v_exports_by_country').select('*');
  (exp.data||[]).forEach(r=>{ const g=GEO[r.country_iso2]; if(!g) return; bubble(g, Number(r.export_value_zar||0), '#22d3ee', `${r.country_iso2}: ZAR ${Math.round(r.export_value_zar).toLocaleString()}`); arc(hub, g, '#22d3ee'); });

  const recentInv = await supabase.from('invoices').select('id, invoice_date').order('invoice_date',{ascending:false}).limit(5);
  const tbody=document.querySelector('#tblOrders tbody');
  for(const inv of (recentInv.data||[])){
    const item = await supabase.from('invoice_items').select('description, quantity, line_total_zar').eq('invoice_id', inv.id).limit(1);
    const it = (item.data&&item.data[0])?item.data[0]:{description:'â€”',quantity:'â€”',line_total_zar:'â€”'};
    const tr=document.createElement('tr');
    [inv.id, it.description, it.quantity, Math.round(it.line_total_zar||0).toLocaleString()].forEach(t=>{ const td=document.createElement('td'); td.textContent=t; tr.appendChild(td); });
    tbody.appendChild(tr);
  }
</script>

</body>
</html>
